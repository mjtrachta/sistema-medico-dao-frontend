<div class="recetas-container">
  <h2>Recetas Electrónicas</h2>

  <div *ngIf="loading" class="loading">Cargando...</div>
  <div *ngIf="error" class="error">{{ error }}</div>

  <div *ngIf="!loading && !error && recetas.length === 0" class="empty-message">
    No hay recetas registradas
  </div>

  <div *ngIf="!loading && !error && recetas.length > 0" class="table-container">
    <table class="recetas-table">
      <thead>
        <tr>
          <th>Código</th>
          <th>Fecha Emisión</th>
          <th>Paciente</th>
          <th>Médico</th>
          <th>Diagnóstico</th>
          <th>Fecha Vencimiento</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let receta of recetas">
          <td>{{ receta.codigo_receta }}</td>
          <td>{{ receta.fecha_emision }}</td>
          <td>{{ receta.paciente?.nombre_completo }}</td>
          <td>{{ receta.medico?.nombre_completo }}</td>
          <td>{{ receta.diagnostico }}</td>
          <td>{{ receta.fecha_vencimiento }}</td>
          <td>
            <span [class]="getEstadoClass(receta.estado || '')">
              {{ receta.estado }}
            </span>
          </td>
          <td>
            <button class="btn-view" (click)="viewReceta(receta)">Ver</button>
            <button
              *ngIf="receta.estado === 'activa'"
              class="btn-cancelar"
              (click)="cancelarReceta(receta.id!)">
              Cancelar
            </button>
            <!-- Las recetas son documentos médico-legales. No se pueden eliminar, solo cancelar. -->
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Modal para ver detalles de receta -->
  <div *ngIf="showModal" class="modal-overlay" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Detalle de Receta Electrónica</h3>
        <button class="btn-close" (click)="closeModal()">×</button>
      </div>
      <div class="modal-body" *ngIf="selectedReceta">
        <div class="detail-section">
          <h4>Información General</h4>
          <div class="detail-item">
            <strong>Código:</strong>
            <span>{{ selectedReceta.codigo_receta }}</span>
          </div>
          <div class="detail-item">
            <strong>Fecha Emisión:</strong>
            <span>{{ selectedReceta.fecha_emision }}</span>
          </div>
          <div class="detail-item">
            <strong>Fecha Vencimiento:</strong>
            <span>{{ selectedReceta.fecha_vencimiento }}</span>
          </div>
          <div class="detail-item">
            <strong>Estado:</strong>
            <span [class]="getEstadoClass(selectedReceta.estado || '')">{{ selectedReceta.estado }}</span>
          </div>
        </div>

        <div class="detail-section">
          <h4>Paciente</h4>
          <div class="detail-item">
            <strong>Nombre:</strong>
            <span>{{ selectedReceta.paciente?.nombre_completo }}</span>
          </div>
        </div>

        <div class="detail-section">
          <h4>Médico</h4>
          <div class="detail-item">
            <strong>Nombre:</strong>
            <span>{{ selectedReceta.medico?.nombre_completo }}</span>
          </div>
        </div>

        <div class="detail-section" *ngIf="selectedReceta.diagnostico">
          <h4>Diagnóstico</h4>
          <p>{{ selectedReceta.diagnostico }}</p>
        </div>

        <div class="detail-section" *ngIf="selectedReceta.items && selectedReceta.items.length > 0">
          <h4>Medicamentos Recetados</h4>
          <div class="medicamentos-list">
            <div *ngFor="let item of selectedReceta.items" class="medicamento-card">
              <h5>{{ item.nombre_medicamento }}</h5>
              <div class="medicamento-details">
                <div class="detail-item">
                  <strong>Dosis:</strong>
                  <span>{{ item.dosis }}</span>
                </div>
                <div class="detail-item">
                  <strong>Frecuencia:</strong>
                  <span>{{ item.frecuencia }}</span>
                </div>
                <div class="detail-item" *ngIf="item.duracion_dias">
                  <strong>Duración:</strong>
                  <span>{{ item.duracion_dias }} días</span>
                </div>
                <div class="detail-item" *ngIf="item.cantidad">
                  <strong>Cantidad:</strong>
                  <span>{{ item.cantidad }}</span>
                </div>
                <div *ngIf="item.instrucciones" class="indicaciones">
                  <strong>Instrucciones:</strong>
                  <p>{{ item.instrucciones }}</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" (click)="closeModal()">Cerrar</button>
      </div>
    </div>
  </div>
</div>
