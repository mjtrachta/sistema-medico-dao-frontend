<div class="historias-container">
  <h2>Historias Clínicas - Agrupadas por Paciente</h2>

  <div *ngIf="loading" class="loading">Cargando...</div>
  <div *ngIf="error" class="error">{{ error }}</div>

  <div *ngIf="!loading && !error && pacientesHistorial.length === 0" class="empty-message">
    No hay historias clínicas registradas
  </div>

  <div *ngIf="!loading && !error && pacientesHistorial.length > 0" class="pacientes-container">
    <!-- Cada paciente con sus historias -->
    <div *ngFor="let pacienteHistorial of pacientesHistorial" class="paciente-card">
      <!-- Header del paciente (clickeable para expandir/colapsar) -->
      <div class="paciente-header" (click)="toggleExpand(pacienteHistorial)">
        <div class="paciente-info">
          <h3>{{ pacienteHistorial.paciente_nombre }}</h3>
          <span class="nro-historia" *ngIf="pacienteHistorial.nro_historia_clinica">
            HC: {{ pacienteHistorial.nro_historia_clinica }}
          </span>
          <span class="total-consultas">
            {{ pacienteHistorial.historias.length }} consulta(s) registrada(s)
          </span>
        </div>
        <div class="expand-icon">
          {{ pacienteHistorial.expanded ? '▼' : '▶' }}
        </div>
      </div>

      <!-- Timeline de historias (expandible) -->
      <div class="historias-timeline" *ngIf="pacienteHistorial.expanded">
        <div *ngFor="let historia of pacienteHistorial.historias; let i = index" class="historia-entry">
          <div class="timeline-marker">
            <div class="timeline-dot"></div>
            <div class="timeline-line" *ngIf="i < pacienteHistorial.historias.length - 1"></div>
          </div>
          <div class="historia-content">
            <div class="historia-fecha">
              {{ historia.fecha_consulta || historia.fecha | date: 'dd/MM/yyyy HH:mm' }}
            </div>
            <div class="historia-details">
              <div class="detail-row">
                <strong>Médico:</strong>
                <span>{{ historia.medico?.nombre_completo }}</span>
              </div>
              <div class="detail-row">
                <strong>Diagnóstico:</strong>
                <span>{{ historia.diagnostico }}</span>
              </div>
              <div class="detail-row" *ngIf="historia.tratamiento">
                <strong>Tratamiento:</strong>
                <span>{{ historia.tratamiento }}</span>
              </div>
            </div>
            <button class="btn-view-small" (click)="viewHistoria(historia)">
              Ver Detalle Completo
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para ver detalles -->
  <div *ngIf="showModal" class="modal-overlay" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Detalle de Historia Clínica</h3>
        <button class="btn-close" (click)="closeModal()">×</button>
      </div>
      <div class="alert-info">
        <strong>ℹ️ Documento Médico-Legal:</strong> Las historias clínicas son documentos permanentes e inmutables.
        No pueden ser editadas ni eliminadas para preservar la integridad del registro médico.
      </div>
      <div class="modal-body" *ngIf="selectedHistoria">
        <div class="detail-section">
          <h4>Información de la Consulta</h4>
          <div class="detail-item">
            <strong>Fecha:</strong>
            <span>{{ selectedHistoria.fecha_consulta }}</span>
          </div>
          <div class="detail-item">
            <strong>Paciente:</strong>
            <span>{{ selectedHistoria.paciente?.nombre_completo }}</span>
          </div>
          <div class="detail-item">
            <strong>Médico:</strong>
            <span>{{ selectedHistoria.medico?.nombre_completo }}</span>
          </div>
        </div>

        <div class="detail-section">
          <h4>Motivo de Consulta</h4>
          <p>{{ selectedHistoria.motivo_consulta || 'No especificado' }}</p>
        </div>

        <div class="detail-section">
          <h4>Diagnóstico</h4>
          <p>{{ selectedHistoria.diagnostico }}</p>
        </div>

        <div class="detail-section" *ngIf="selectedHistoria.tratamiento">
          <h4>Tratamiento</h4>
          <p>{{ selectedHistoria.tratamiento }}</p>
        </div>

        <div class="detail-section" *ngIf="selectedHistoria.observaciones">
          <h4>Observaciones</h4>
          <p>{{ selectedHistoria.observaciones }}</p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" (click)="closeModal()">Cerrar</button>
      </div>
    </div>
  </div>
</div>
