<div class="historias-container">
  <h2 *ngIf="!isPaciente">Historias Cl√≠nicas - Agrupadas por Paciente</h2>
  <h2 *ngIf="isPaciente">Mi Historia Cl√≠nica</h2>

  <div *ngIf="loading" class="loading">Cargando...</div>
  <div *ngIf="error" class="error">{{ error }}</div>

  <!-- Vista para pacientes -->
  <div *ngIf="isPaciente && !loading && !error">
    <div *ngIf="historias.length === 0" class="empty-message">
      <div class="empty-icon">üìã</div>
      <h3>No tienes historias cl√≠nicas registradas</h3>
      <p>Cuando tengas consultas m√©dicas, aqu√≠ aparecer√°n tus historias cl√≠nicas.</p>
    </div>

    <div *ngIf="historias.length > 0" class="paciente-view">
      <div class="paciente-info-card">
        <div class="info-header">
          <h3>{{ currentUser?.nombre_completo }}</h3>
          <span class="nro-historia" *ngIf="currentUser?.nro_historia_clinica">
            Historia Cl√≠nica: {{ currentUser?.nro_historia_clinica }}
          </span>
        </div>
        <div class="stats">
          <div class="stat-item">
            <span class="stat-number">{{ historias.length }}</span>
            <span class="stat-label">Consulta{{ historias.length === 1 ? '' : 's' }} registrada{{ historias.length === 1 ? '' : 's' }}</span>
          </div>
        </div>
      </div>

      <!-- Timeline de historias para paciente -->
      <div class="historias-timeline-paciente">
        <div *ngFor="let historia of historias; let i = index" class="historia-entry-paciente">
          <div class="timeline-marker-paciente">
            <div class="timeline-dot-paciente"></div>
            <div class="timeline-line-paciente" *ngIf="i < historias.length - 1"></div>
          </div>
          <div class="historia-card">
            <div class="historia-fecha-main">
              {{ formatFecha(historia.fecha_consulta || historia.fecha) }}
            </div>
            <div class="historia-hora">
              {{ formatHora(historia.fecha_consulta || historia.fecha) }}
            </div>
            <div class="historia-details-paciente">
              <div class="detail-row-paciente">
                <div class="detail-label">M√©dico tratante</div>
                <div class="detail-value">{{ historia.medico?.nombre_completo }}</div>
              </div>
              <div class="detail-row-paciente">
                <div class="detail-label">Motivo de consulta</div>
                <div class="detail-value">{{ historia.motivo_consulta || 'No especificado' }}</div>
              </div>
              <div class="detail-row-paciente">
                <div class="detail-label">Diagn√≥stico</div>
                <div class="detail-value">{{ historia.diagnostico }}</div>
              </div>
              <div class="detail-row-paciente" *ngIf="historia.tratamiento">
                <div class="detail-label">Tratamiento indicado</div>
                <div class="detail-value">{{ historia.tratamiento }}</div>
              </div>
            </div>
            <button class="btn-view-detail" (click)="viewHistoria(historia)">
              Ver detalles completos
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Vista para otros roles (m√©dicos, admin, etc.) -->
  <div *ngIf="!isPaciente && !loading && !error">
    <div *ngIf="pacientesHistorial.length === 0" class="empty-message">
      No hay historias cl√≠nicas registradas
    </div>
    <div *ngIf="pacientesHistorial.length > 0" class="pacientes-container">
      <!-- Cada paciente con sus historias -->
      <div *ngFor="let pacienteHistorial of pacientesHistorial" class="paciente-card">
        <!-- Header del paciente (clickeable para expandir/colapsar) -->
        <div class="paciente-header" (click)="toggleExpand(pacienteHistorial)">
          <div class="paciente-info">
            <h3>{{ pacienteHistorial.paciente_nombre }}</h3>
            <span class="nro-historia" *ngIf="pacienteHistorial.nro_historia_clinica">
              HC: {{ pacienteHistorial.nro_historia_clinica }}
            </span>
            <span class="total-consultas">
              {{ pacienteHistorial.historias.length }} consulta(s) registrada(s)
            </span>
          </div>
          <div class="expand-icon">
            {{ pacienteHistorial.expanded ? '‚ñº' : '‚ñ∂' }}
          </div>
        </div>

        <!-- Timeline de historias (expandible) -->
        <div class="historias-timeline" *ngIf="pacienteHistorial.expanded">
          <div *ngFor="let historia of pacienteHistorial.historias; let i = index" class="historia-entry">
            <div class="timeline-marker">
              <div class="timeline-dot"></div>
              <div class="timeline-line" *ngIf="i < pacienteHistorial.historias.length - 1"></div>
            </div>
            <div class="historia-content">
              <div class="historia-fecha">
                {{ historia.fecha_consulta || historia.fecha | date: 'dd/MM/yyyy HH:mm' }}
              </div>
              <div class="historia-details">
                <div class="detail-row">
                  <strong>M√©dico:</strong>
                  <span>{{ historia.medico?.nombre_completo }}</span>
                </div>
                <div class="detail-row">
                  <strong>Diagn√≥stico:</strong>
                  <span>{{ historia.diagnostico }}</span>
                </div>
                <div class="detail-row" *ngIf="historia.tratamiento">
                  <strong>Tratamiento:</strong>
                  <span>{{ historia.tratamiento }}</span>
                </div>
              </div>
              <button class="btn-view-small" (click)="viewHistoria(historia)">
                Ver Detalle Completo
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para ver detalles -->
  <div *ngIf="showModal" class="modal-overlay" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Detalle de Historia Cl√≠nica</h3>
        <button class="btn-close" (click)="closeModal()">√ó</button>
      </div>
      <div class="alert-info">
        <strong>‚ÑπÔ∏è Documento M√©dico-Legal:</strong> Las historias cl√≠nicas son documentos permanentes e inmutables.
        No pueden ser editadas ni eliminadas para preservar la integridad del registro m√©dico.
      </div>
      <div class="modal-body" *ngIf="selectedHistoria">
        <div class="detail-section">
          <h4>Informaci√≥n de la Consulta</h4>
          <div class="detail-item">
            <strong>Fecha:</strong>
            <span>{{ selectedHistoria.fecha_consulta }}</span>
          </div>
          <div class="detail-item">
            <strong>Paciente:</strong>
            <span>{{ selectedHistoria.paciente?.nombre_completo }}</span>
          </div>
          <div class="detail-item">
            <strong>M√©dico:</strong>
            <span>{{ selectedHistoria.medico?.nombre_completo }}</span>
          </div>
        </div>

        <div class="detail-section">
          <h4>Motivo de Consulta</h4>
          <p>{{ selectedHistoria.motivo_consulta || 'No especificado' }}</p>
        </div>

        <div class="detail-section">
          <h4>Diagn√≥stico</h4>
          <p>{{ selectedHistoria.diagnostico }}</p>
        </div>

        <div class="detail-section" *ngIf="selectedHistoria.tratamiento">
          <h4>Tratamiento</h4>
          <p>{{ selectedHistoria.tratamiento }}</p>
        </div>

        <div class="detail-section" *ngIf="selectedHistoria.observaciones">
          <h4>Observaciones</h4>
          <p>{{ selectedHistoria.observaciones }}</p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" (click)="closeModal()">Cerrar</button>
      </div>
    </div>
  </div>
</div>
